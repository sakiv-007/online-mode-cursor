<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe</title>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="/assets/fevicon.png" type="image/x-icon">
    <!-- Add Font Awesome for the home icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: url('/assets/gaming-bg-pattern.png'), linear-gradient(135deg, #1a1533 0%, #121212 100%);
            background-size: 200px, cover;
            padding: 20px;
            color: #f8f8f8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #7e57c2 rgba(18, 18, 18, 0.4);
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(30, 30, 46, 0.85);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(126, 87, 194, 0.3);
            text-align: center;
        }
        
        h1 {
            color: #7e57c2;
            font-size: 2.8rem;
            margin-top: -0.5rem;
            margin-bottom: 0.8rem;
            text-align: center;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(126, 87, 194, 0.5);
            letter-spacing: 2px;
        }
        
        .status {
            background: rgba(30, 30, 46, 0.5);
            padding: 0.6rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: #f8f8f8;
            text-align: center;
        }
        
        .game-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
            margin-top: 1rem;
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .game-core {
            height: calc(100vh - 230px);
            max-height: 500px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            justify-content: space-between;
        }
        
        .game-grid {
            margin-bottom: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 15px;
            margin-bottom: 1rem;
            position: relative;
            width: 100%;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
            aspect-ratio: 1/1;
        }
        
        .cell {
            background: rgba(18, 18, 18, 0.7) !important;
            height: auto !important;
            aspect-ratio: 1/1;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            font-size: 3rem !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            border-radius: 12px !important;
            transition: all 0.3s !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2) !important;
            border: 1px solid #333333 !important;
        }
        
        .cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            border-color: #7e57c2;
            background: rgba(40, 40, 60, 0.9) !important;
        }
        
        .cell.x {
            color: #4284f5 !important;
            text-shadow: 0 0 10px rgba(66, 132, 245, 0.8) !important;
        }
        
        .cell.o {
            color: #4ade80 !important;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.8) !important;
        }
        
        .winning-cell {
            animation: pulse 1.5s infinite;
        }
        
        .winning-line {
            position: absolute;
            height: 5px;
            transform-origin: left center;
            width: 0;
            transition: width 0.5s ease-in-out;
            border-radius: 2.5px;
            z-index: 5;
        }
        
        .x-winning-line {
            background: #4284f5 !important;
            box-shadow: 0 0 10px rgba(66, 132, 245, 0.8) !important;
        }
        
        .o-winning-line {
            background: #4ade80 !important;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.8) !important;
        }
        
        .game-controls {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .score-board {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        
        .score {
            background: rgba(30, 30, 46, 0.5);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .score span:first-child {
            display: block;
            font-weight: 600;
            color: #b0b0b0;
            margin-bottom: 0.3rem;
            font-size: 0.8rem;
        }
        
        .score span:last-child {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f8f8f8;
        }
        
        .room-info {
            margin-top: 20px;
            border-top: 1px solid rgba(126, 87, 194, 0.3);
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(18, 18, 18, 0.4);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .room-code {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .code-value {
            background: rgba(18, 18, 18, 0.7);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #b0b0b0;
        }
        
        .invite-btn {
            background: #7e57c2;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.75rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .invite-btn:hover {
            background: #9575cd;
            transform: translateY(-2px);
        }
        
        .connection-status {
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .status-connected {
            background: rgba(0, 230, 118, 0.2);
            color: #00e676;
        }
        
        .status-waiting {
            background: rgba(255, 171, 0, 0.2);
            color: #ffab00;
        }
        
        .status-disconnected {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }
        
        .chat-container {
            height: calc(100vh - 230px);
            max-height: 500px;
            background: rgba(30, 30, 46, 0.7);
            border-radius: 15px;
            border: 1px solid #333;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }
        
        .chat-container:hover {
            border-color: #7e57c2;
            box-shadow: 0 0 15px rgba(126, 87, 194, 0.4);
        }
        
        .chat-header {
            background: rgba(18, 18, 18, 0.7);
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-participants {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .participants-count {
            background: rgba(126, 87, 194, 0.3);
            padding: 0.2rem 0.5rem;
            border-radius: 50px;
            font-size: 0.8rem;
            color: #7e57c2;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: none;
            scrollbar-width: thin;
            scrollbar-color: #7e57c2 rgba(18, 18, 18, 0.4);
        }
        
        /* Custom scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(18, 18, 18, 0.4);
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #7e57c2;
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #9575cd;
        }
        
        .chat-message {
            background: rgba(18, 18, 18, 0.5);
            padding: 0.75rem;
            border-radius: 8px;
            max-width: 85%;
            word-break: break-word;
            position: relative;
        }
        
        .chat-message.sent {
            align-self: flex-end;
            background: rgba(126, 87, 194, 0.3);
            border-top-right-radius: 0;
        }
        
        .chat-message.received {
            align-self: flex-start;
            background: rgba(92, 107, 192, 0.3);
            border-top-left-radius: 0;
        }
        
        .message-sender {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
            color: #b0b0b0;
        }
        
        .message-sender.player-x {
            color: #7e57c2;
        }
        
        .message-sender.player-o {
            color: #5c6bc0;
        }
        
        .message-sender.spectator {
            color: #4db6ac;
        }
        
        .message-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: #b0b0b0;
            text-align: right;
            margin-top: 0.3rem;
        }
        
        .chat-input {
            display: flex;
            padding: 0.75rem;
            background: rgba(18, 18, 18, 0.7);
            border-top: 1px solid #333;
        }
        
        .chat-input input {
            flex: 1;
            background: rgba(30, 30, 46, 0.7);
            border: 1px solid #333;
            border-radius: 8px 0 0 8px;
            padding: 0.6rem 1rem;
            color: #f8f8f8;
            outline: none;
            font-size: 0.9rem;
        }
        
        .chat-input input:focus {
            border-color: #7e57c2;
        }
        
        .chat-input button {
            background: #7e57c2;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            padding: 0 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chat-input button:hover {
            background: #9575cd;
        }
        
        .spectator-badge {
            background: rgba(77, 182, 172, 0.3);
            color: #4db6ac;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 50px;
            margin-left: 0.5rem;
        }
        
        .player-badge {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 50px;
            margin-left: 0.5rem;
        }
        
        .player-x-badge {
            background: rgba(126, 87, 194, 0.3);
            color: #7e57c2;
        }
        
        .player-o-badge {
            background: rgba(92, 107, 192, 0.3);
            color: #5c6bc0;
        }
        
        .player-symbol {
            color: #7e57c2;
            font-weight: 700;
        }
        
        .game-controls {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        button#restartButton {
            background: #7e57c2;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 auto;
            display: block;
            width: 100%;
            max-width: 350px;
        }
        
        button#restartButton:hover {
            background: #9575cd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .popup-content {
            background: rgba(30, 30, 46, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #7e57c2;
            animation: popup-appear 0.3s ease-out;
        }
        
        .popup-content h2 {
            color: #7e57c2;
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }
        
        .popup-content p {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: #f8f8f8;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #b0b0b0;
            transition: color 0.2s;
        }
        
        .close-btn:hover {
            color: #f8f8f8;
        }
        
        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(30, 30, 46, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #f8f8f8;
            font-size: 1.2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            border: 1px solid #333;
            text-decoration: none;
            transition: all 0.3s;
            z-index: 100;
        }
        
        .home-btn:hover {
            background: #7e57c2;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.75rem 1rem;
            background: rgba(30, 30, 46, 0.9);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-icon {
            font-size: 1.2rem;
        }
        
        .notification-info .notification-icon {
            color: #5c6bc0;
        }
        
        .notification-success .notification-icon {
            color: #00e676;
        }
        
        .notification-warning .notification-icon {
            color: #ffab00;
        }
        
        .notification-danger .notification-icon {
            color: #ff5252;
        }
        
        .notification-text {
            font-size: 0.9rem;
            color: #f8f8f8;
        }
        
        /* Responsive layout for mobile */
        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .game-core {
                height: auto;
                max-height: none;
            }
            
            .game-board {
                max-width: 300px;
            }
            
            .cell {
                font-size: 2.5rem !important;
            }
            
            .chat-container {
                margin-top: 1rem;
                height: 280px;
                min-height: auto;
                max-height: 280px;
            }
            
            .chat-messages {
                max-height: 160px;
            }
            
            .game-controls {
                gap: 10px;
            }
            
            button#restartButton {
                position: static;
                margin: 0 auto;
                padding: 0.6rem 1rem;
            }
            
            .room-info {
                margin-bottom: 1rem;
                margin-top: 0;
                border-top: none;
                padding-top: 0;
            }
        }
        
        @media (max-width: 500px) {
            h1 {
                font-size: 2rem;
                margin-top: 0;
            }
            
            .container {
                padding: 1.2rem;
            }
            
            .game-board {
                max-width: 250px;
                grid-gap: 10px;
            }
            
            .cell {
                font-size: 2rem !important;
            }
            
            .chat-container {
                height: 250px;
            }
            
            .status {
                padding: 0.5rem;
                font-size: 0.9rem;
                margin-bottom: 1rem;
            }
            
            .score {
                padding: 5px 10px;
                min-width: 80px;
            }
            
            .score span:last-child {
                font-size: 1.2rem;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes popup-appear {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Webkit scrollbar for the entire body */
        body::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        body::-webkit-scrollbar-track {
            background: rgba(18, 18, 18, 0.4);
        }
        
        body::-webkit-scrollbar-thumb {
            background: #7e57c2;
            border-radius: 5px;
        }
        
        body::-webkit-scrollbar-thumb:hover {
            background: #9575cd;
        }
    </style>
</head>
<body>
    <a href="/" class="home-btn" title="Back to Lobby">
        <i class="fas fa-home"></i>
    </a>
    <div class="container">
        <h1>Tic-Tac-Toe</h1>
        
        <div class="status" id="status">Connecting to server...</div>
        
        <div class="game-container">
            <div class="game-area">
                <div class="game-core">
                    <div class="game-grid">
                        <div class="game-board" id="board">
                            <div class="cell" data-cell-index="0"></div>
                            <div class="cell" data-cell-index="1"></div>
                            <div class="cell" data-cell-index="2"></div>
                            <div class="cell" data-cell-index="3"></div>
                            <div class="cell" data-cell-index="4"></div>
                            <div class="cell" data-cell-index="5"></div>
                            <div class="cell" data-cell-index="6"></div>
                            <div class="cell" data-cell-index="7"></div>
                            <div class="cell" data-cell-index="8"></div>
                        </div>
                    </div>
                    
                    <div class="game-controls">
                        <div class="score-board">
                            <div class="score">
                                <span id="playerXLabel">Player 1 X:</span>
                                <span id="scoreX">0</span>
                            </div>
                            <div class="score">
                                <span id="playerOLabel">Player 2 O:</span>
                                <span id="scoreO">0</span>
                            </div>
                        </div>
                        
                        <button id="restartButton">Restart Game</button>
                    </div>
                </div>
                
                <div class="room-info">
                    <div class="room-code">
                        <span>Room:</span>
                        <span id="roomIdDisplay" class="code-value"></span>
                        <button id="copyRoomId" class="invite-btn">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div id="connectionStatus" class="connection-status status-waiting">
                        <i class="fas fa-circle"></i>
                        <span>Waiting for opponent...</span>
                    </div>
                </div>
            </div>
            
            <!-- Chat Container - Now on the right side -->
            <div class="chat-container">
                <div class="chat-header">
                    <span>Game Chat</span>
                    <div class="chat-participants">
                        <div class="participants-count">
                            <i class="fas fa-users"></i>
                            <span id="participantCount">0</span>
                        </div>
                    </div>
                </div>
                <div id="chatMessages" class="chat-messages">
                    <!-- Messages will be added here dynamically -->
                    <div class="chat-message system">
                        <div class="message-content">Welcome to the game chat! Be respectful and have fun!</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type your message..." maxlength="150">
                    <button id="sendMessage"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Congratulations Popup -->
    <div id="congratsPopup" class="popup">
        <div class="popup-content">
            <span class="close-btn">&times;</span>
            <h2>Congratulations!</h2>
            <p id="winnerMessage"></p>
            <div class="confetti"></div>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification">
        <i id="notificationIcon" class="notification-icon fas fa-info-circle"></i>
        <span id="notificationText" class="notification-text"></span>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Connect to Socket.io server
            const socket = io();
            
            // Get data from session storage
            const playerName = sessionStorage.getItem('playerName');
            const playerSymbol = sessionStorage.getItem('playerSymbol');
            let roomId = sessionStorage.getItem('roomId');
            const isHost = sessionStorage.getItem('isHost') === 'true';
            const isRandomMatch = sessionStorage.getItem('isRandomMatch') === 'true';
            
            // Try to get opponent name and players list from sessionStorage
            let opponentName = sessionStorage.getItem('opponentName') || '';
            let players = [];
            try {
                const playersJson = sessionStorage.getItem('players');
                if (playersJson) {
                    players = JSON.parse(playersJson);
                }
            } catch (e) {
                console.error('Error parsing players:', e);
            }
            
            // Game variables
            let gameActive = false;
            let currentPlayer = "X";
            let gameState = ["", "", "", "", "", "", "", "", ""];
            let scores = { X: 0, O: 0 };
            let isSpectator = false;
            let participants = [];
            
            console.log('Game page data:', { playerName, playerSymbol, roomId, isHost, isRandomMatch, opponentName, players });
            
            // Check if we have the required data
            if (!playerName || !roomId) {
                alert('Missing player information. Redirecting to lobby...');
                window.location.href = '/';
                return;
            }
            
            // Function to get room ID from URL
            function getUrlRoomId() {
                const pathParts = window.location.pathname.split('/');
                return pathParts[pathParts.length - 1];
            }
            
            // If roomId is not in session storage, try to get it from URL
            if (!roomId) {
                roomId = getUrlRoomId();
            }
            
            // Check room status
            socket.emit('checkRoom', roomId);
            
            // Additional information for random matches
            if (isRandomMatch) {
                console.log('This is a random match, bypassing waiting room');
                socket.emit('randomMatchGameStarted', { roomId });
            }
            
            socket.on('roomStatus', ({ roomId, exists, status }) => {
                if (!exists) {
                    alert('Room does not exist. Redirecting to lobby...');
                    window.location.href = '/';
                    return;
                }
                
                console.log('Room status check:', status);
                
                // Check if room is in waiting status
                if (status === 'waiting') {
                    console.log('Game not started yet, checking if random match');
                    
                    // Check if this is a random match (should bypass waiting room)
                    if (!isRandomMatch) {
                        console.log('Not a random match, redirecting to waiting room');
                        window.location.href = `/waiting/${roomId}`;
                        return;
                    } else {
                        console.log('Random match, staying in game page');
                        // For random matches, stay in the game page
                    }
                }
                
                // Connect to room
                if (playerSymbol) {
                    socket.emit('reconnectToRoom', { roomId, playerName, playerSymbol });
                } else {
                    socket.emit('joinRoom', { roomId, playerName });
                }
            });
            
            // Handle random match cancellation
            socket.on('randomMatchCancelled', ({ message, cancelledBy, reason }) => {
                console.log('Random match cancelled:', message);
                
                // Show notification
                showNotification('error', message || 'The match was cancelled.');
                
                // Set a timeout to allow the notification to be seen before redirecting
                setTimeout(() => {
                    alert('Match cancelled. Returning to lobby.');
                    window.location.href = '/';
                }, 1000);
            });
            
            // DOM elements
            const statusDisplay = document.getElementById('status');
            const cells = document.querySelectorAll('.cell');
            const restartButton = document.getElementById('restartButton');
            const roomIdDisplay = document.getElementById('roomIdDisplay');
            const copyRoomIdBtn = document.getElementById('copyRoomId');
            const connectionStatus = document.getElementById('connectionStatus');
            const scoreXDisplay = document.getElementById('scoreX');
            const scoreODisplay = document.getElementById('scoreO');
            const playerXLabel = document.getElementById('playerXLabel');
            const playerOLabel = document.getElementById('playerOLabel');
            const congratsPopup = document.getElementById('congratsPopup');
            const winnerMessage = document.getElementById('winnerMessage');
            const closeBtn = document.querySelector('.close-btn');
            const board = document.getElementById('board');
            const notification = document.getElementById('notification');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationText = document.getElementById('notificationText');
            const gameStatusElement = document.getElementById('status');
            
            // Chat elements
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendMessageBtn = document.getElementById('sendMessage');
            const participantCount = document.getElementById('participantCount');
            
            // Ensure the game board is visible
            if (board) {
                board.style.display = 'grid';
                console.log('Set board display to grid');
            } else {
                console.error('Board element not found!');
            }
            
            // Display room ID
            roomIdDisplay.textContent = roomId;
            
            // Initialize the game state for random matches
            if (isRandomMatch) {
                console.log('This is a random match, initializing game immediately');
                gameActive = true;
                
                // Update status display
                if (playerSymbol === currentPlayer) {
                    statusDisplay.innerHTML = `Your turn <span class="player-symbol">(${playerSymbol})</span>`;
                    enableCellClicks();
                } else {
                    statusDisplay.innerHTML = `Opponent's turn <span class="player-symbol">(${currentPlayer})</span>`;
                    disableCellClicks();
                }
                
                // Update connection status
                updateConnectionStatus('connected');
                
                // Initialize the game board and controls
                initializeGameForRandomMatch();
            } else {
                // Initially disable cell clicks until game starts
                disableCellClicks();
            }
            
            // Helper function to initialize game board for random matches
            function initializeGameForRandomMatch() {
                console.log('Initializing game for random match, player symbol:', playerSymbol);
                
                // Set the room ID display
                roomIdDisplay.textContent = roomId;
                
                // Initialize scores
                scoreXDisplay.textContent = '0';
                scoreODisplay.textContent = '0';
                
                // Set default opponent name if not available
                if (!opponentName || opponentName.trim() === '') {
                    opponentName = 'Opponent';
                }
                
                // Update player labels - initially with generic names until opponent name is received
                if (playerSymbol === 'X') {
                    playerXLabel.textContent = `You (X):`;
                    playerOLabel.textContent = `${opponentName} (O):`;
                    
                    // Update status since X goes first
                    statusDisplay.innerHTML = `Your turn <span class="player-symbol">(${playerSymbol})</span>`;
                } else {
                    playerXLabel.textContent = `${opponentName} (X):`;
                    playerOLabel.textContent = `You (O):`;
                    
                    // Update status since X goes first
                    statusDisplay.innerHTML = `${opponentName}'s turn <span class="player-symbol">(X)</span>`;
                }
                
                // Make board visible and clickable as appropriate
                board.style.display = 'grid';
                
                if (playerSymbol === 'X') {
                    // X goes first
                    enableCellClicks();
                } else {
                    disableCellClicks();
                }
                
                // Add a welcome message to chat
                addChatMessage({
                    message: `Welcome to Room ${roomId}! Random match started.`,
                    isSystem: true,
                    timestamp: Date.now()
                });
            }
            
            // Event listeners for cells
            cells.forEach(cell => {
                cell.addEventListener('click', () => handleCellClick(cell));
            });
            
            // Restart button event listener
            restartButton.addEventListener('click', () => {
                if (roomId) {
                    socket.emit('restartGame', roomId);
                    console.log('Sending restart game request for room:', roomId);
                    showNotification('info', 'Requested game restart...');
                }
            });
            
            // Copy room ID button
            copyRoomIdBtn.addEventListener('click', () => {
                const gameUrl = `${window.location.origin}/game/${roomId}`;
                navigator.clipboard.writeText(gameUrl)
                    .then(() => {
                        showNotification('success', 'Game link copied!');
                        copyRoomIdBtn.innerHTML = '<i class="fas fa-check"></i> Copied';
                        setTimeout(() => {
                            copyRoomIdBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                    });
            });
            
            // Close congratulations popup
            closeBtn.addEventListener('click', () => {
                congratsPopup.style.display = 'none';
            });
            
            // Chat event listeners
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && chatInput.value.trim()) {
                    sendChatMessage();
                }
            });
            
            sendMessageBtn.addEventListener('click', () => {
                if (chatInput.value.trim()) {
                    sendChatMessage();
                }
            });
            
            function sendChatMessage() {
                const message = chatInput.value.trim();
                if (message) {
                    // Send the message to server
                    socket.emit('chatMessage', {
                        roomId,
                        sender: playerName,
                        message,
                        symbol: isSpectator ? 'spectator' : playerSymbol
                    });
                    
                    // Clear input field
                    chatInput.value = '';
                }
            }
            
            // Function to add a message to the chat
            function addChatMessage(data) {
                const { sender, message, symbol, timestamp, isSystem } = data;
                
                // Create message element
                const messageElement = document.createElement('div');
                
                if (isSystem) {
                    messageElement.className = 'chat-message system';
                    messageElement.innerHTML = `
                        <div class="message-content">${message}</div>
                    `;
                } else {
                    // Determine if this message is from the current user
                    const isSelf = sender === playerName;
                    messageElement.className = `chat-message ${isSelf ? 'sent' : 'received'}`;
                    
                    let senderClass = 'message-sender';
                    if (symbol === 'X') senderClass += ' player-x';
                    else if (symbol === 'O') senderClass += ' player-o';
                    else if (symbol === 'spectator') senderClass += ' spectator';
                    
                    let symbolBadge = '';
                    if (symbol === 'X') {
                        symbolBadge = '<span class="player-badge player-x-badge">X</span>';
                    } else if (symbol === 'O') {
                        symbolBadge = '<span class="player-badge player-o-badge">O</span>';
                    } else if (symbol === 'spectator') {
                        symbolBadge = '<span class="spectator-badge">Spectator</span>';
                    }
                    
                    messageElement.innerHTML = `
                        <div class="${senderClass}">${sender}${symbolBadge}</div>
                        <div class="message-content">${message}</div>
                        <div class="message-time">${formatTime(timestamp)}</div>
                    `;
                }
                
                // Add message to chat and scroll to bottom
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Format timestamp for chat
            function formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Update participant count display
            function updateParticipantCount() {
                participantCount.textContent = participants.length;
            }
            
            // Socket.io event handlers
            
            // Player joined event
            socket.on('playerJoined', ({ player }) => {
                console.log(`Player joined event received:`, player);
                
                if (player.name !== playerName) {
                    opponentName = player.name;
                    updateConnectionStatus('connected');
                    
                    // Update player labels with names
                    updatePlayerLabels();
                    
                    showNotification('success', `${opponentName} joined the game!`);
                    
                    // Add system message to chat
                    addChatMessage({
                        message: `${player.name} joined as Player ${player.symbol}`,
                        isSystem: true,
                        timestamp: Date.now()
                    });
                }
                
                // Enable gameplay if not spectator
                if (!isSpectator) {
                    enableCellClicks();
                    gameActive = true;
                    
                    updateStatusDisplay();
                }
                
                // Also notify the server that we are connected
                socket.emit('playerJoined', {
                    player: {
                        id: socket.id,
                        name: playerName,
                        symbol: playerSymbol,
                        isSpectator
                    }
                });
            });
            
            // Spectator joined event
            socket.on('spectatorJoined', ({ spectator }) => {
                console.log(`Spectator joined event received:`, spectator);
                
                showNotification('info', `${spectator.name} joined as spectator`);
                
                // Add system message to chat
                addChatMessage({
                    message: `${spectator.name} joined as spectator`,
                    isSystem: true,
                    timestamp: Date.now()
                });
            });
            
            // Room joined event
            socket.on('roomJoined', (data) => {
                console.log('Room joined data:', data);
                if (data.isHost !== undefined) {
                    isHost = data.isHost;
                    sessionStorage.setItem('isHost', isHost);
                    console.log('Host status updated:', isHost);
                    updateHostControls(isHost);
                }
                
                playerSymbol = data.playerSymbol;
                gameState = data.gameState;
                currentPlayer = data.currentPlayer;
                scores = data.scores;
                isSpectator = data.isSpectator || false;
                participants = data.participants || [];
                
                console.log('Room joined! Game state:', gameState, 'Is spectator:', isSpectator);
                updateParticipantCount();
                
                // Disable restart button for spectators
                if (isSpectator) {
                    restartButton.disabled = true;
                    restartButton.style.opacity = '0.5';
                    restartButton.style.cursor = 'not-allowed';
                }
                
                // Get opponent name
                if (!isSpectator) {
                    const opponent = data.players.find(p => p.symbol !== playerSymbol && (p.symbol === 'X' || p.symbol === 'O'));
                    if (opponent) {
                        opponentName = opponent.name;
                    }
                }
                
                // Update connection status
                updateConnectionStatus('connected');
                
                // Update player labels
                updatePlayerLabels();
                
                // Update score display
                updateScoreDisplay();
                
                // Make sure the board is displayed
                document.getElementById('board').style.display = 'grid';
                
                // Update board display
                updateBoardDisplay();
                
                // Enable gameplay if it's player's turn and not spectator
                if (!isSpectator) {
                    if (currentPlayer === playerSymbol) {
                        enableCellClicks();
                    } else {
                        disableCellClicks();
                    }
                    gameActive = true;
                } else {
                    // Spectators can't click cells
                    disableCellClicks();
                    statusDisplay.innerHTML = `Spectating: ${data.players.find(p => p.symbol === currentPlayer)?.name || currentPlayer}'s turn`;
                }
                
                if (!isSpectator) {
                    updateStatusDisplay();
                }
                
                // Add system message to chat on initial join
                addChatMessage({
                    message: `Welcome to Room ${roomId}! ${isSpectator ? 'You are spectating.' : ''}`,
                    isSystem: true,
                    timestamp: Date.now()
                });
                
                // Show players in chat
                data.players.forEach(player => {
                    if (player.name !== playerName) {
                        let roleText = '';
                        if (player.symbol === 'X' || player.symbol === 'O') {
                            roleText = `Player ${player.symbol}`;
                        } else {
                            roleText = 'Spectator';
                        }
                        
                        addChatMessage({
                            message: `${player.name} is ${roleText}`,
                            isSystem: true,
                            timestamp: Date.now()
                        });
                    }
                });
            });
            
            // Player left event
            socket.on('playerLeft', ({ playerName: leftPlayer, temporary }) => {
                updateConnectionStatus('waiting');
                
                if (temporary) {
                    showNotification('warning', `${leftPlayer} disconnected. Waiting for reconnection...`);
                } else {
                    showNotification('warning', `${leftPlayer} left the game`);
                }
                
                // Add system message to chat
                addChatMessage({
                    message: `${leftPlayer} ${temporary ? 'disconnected temporarily' : 'left the game'}`,
                    isSystem: true,
                    timestamp: Date.now()
                });
                
                // Disable gameplay until reconnection
                disableCellClicks();
                gameActive = false;
                
                statusDisplay.innerHTML = 'Waiting for opponent to reconnect...';
            });
            
            // Participants update event
            socket.on('participantsUpdate', ({ participants: newParticipants }) => {
                participants = newParticipants;
                updateParticipantCount();
            });
            
            // Chat message received event
            socket.on('chatMessage', (messageData) => {
                addChatMessage({
                    ...messageData,
                    timestamp: messageData.timestamp || Date.now()
                });
            });
            
            // Move made event
            socket.on('moveMade', ({ cellIndex, symbol, gameState: newGameState }) => {
                // Update game state
                gameState = newGameState;
                
                // Update the cell display
                cells[cellIndex].innerHTML = symbol;
                cells[cellIndex].classList.add(symbol.toLowerCase());
                
                // Don't enable clicks here - wait for playerTurnChanged event
            });
            
            // Player turn changed event
            socket.on('playerTurnChanged', ({ currentPlayer: newCurrentPlayer }) => {
                currentPlayer = newCurrentPlayer;
                
                if (isSpectator) {
                    // Update status display for spectators
                    const currentPlayerName = participants.find(p => p.symbol === currentPlayer)?.name || '';
                    statusDisplay.innerHTML = `Spectating: ${currentPlayerName}'s turn <span class="player-symbol">(${currentPlayer})</span>`;
                } else {
                    updateStatusDisplay();
                    
                    // Enable/disable cell clicks based on whose turn it is
                    if (currentPlayer === playerSymbol) {
                        enableCellClicks();
                    } else {
                        disableCellClicks();
                    }
                }
            });
            
            // Game over event
            socket.on('gameOver', (data) => {
                gameActive = false;
                disableCellClicks();
                
                // Update scores
                scores = data.scores;
                updateScoreDisplay();
                
                if (data.draw) {
                    statusDisplay.innerHTML = 'Game ended in a draw!';
                    
                    // Add system message to chat
                    addChatMessage({
                        message: `Game ended in a draw!`,
                        isSystem: true,
                        timestamp: Date.now()
                    });
                } else {
                    // Highlight winning cells
                    data.winningCombination.forEach(index => {
                        cells[index].classList.add('winning-cell');
                    });
                    
                    // Draw line over winning cells
                    drawWinningLine(data.winningCombination);
                    
                    // Show winner message
                    const winnerSymbol = data.winner;
                    const winnerName = participants.find(p => p.symbol === winnerSymbol)?.name || '';
                    
                    if (isSpectator) {
                        statusDisplay.innerHTML = `${winnerName} won the game!`;
                    } else {
                        const isPlayerWinner = winnerSymbol === playerSymbol;
                        
                        if (isPlayerWinner) {
                            statusDisplay.innerHTML = 'You won the game!';
                            showCongratsPopup('You');
                        } else {
                            statusDisplay.innerHTML = `${opponentName} won the game!`;
                        }
                    }
                    
                    // Add system message to chat
                    addChatMessage({
                        message: `${winnerName} won the game!`,
                        isSystem: true,
                        timestamp: Date.now()
                    });
                }
            });
            
            // Update when game is restarted
            socket.on('gameRestarted', ({ gameState: newGameState, currentPlayer: newCurrentPlayer }) => {
                // Update game state
                gameState = newGameState;
                currentPlayer = newCurrentPlayer;
                gameActive = true;
                
                console.log('Game restarted! New state:', gameState);
                
                // Clear the board
                cells.forEach(cell => {
                    cell.innerHTML = '';
                    cell.classList.remove('x', 'o', 'winning-cell');
                });
                
                // Remove winning line if it exists
                const existingLine = document.querySelector('.winning-line');
                if (existingLine) {
                    existingLine.remove();
                }
                
                // Make sure the board is visible
                board.style.display = 'grid';
                
                if (isSpectator) {
                    // Update status for spectators
                    const currentPlayerName = participants.find(p => p.symbol === currentPlayer)?.name || '';
                    statusDisplay.innerHTML = `Spectating: ${currentPlayerName}'s turn <span class="player-symbol">(${currentPlayer})</span>`;
                    disableCellClicks();
                } else {
                    // Enable/disable cell clicks based on whose turn it is
                    if (currentPlayer === playerSymbol) {
                        enableCellClicks();
                    } else {
                        disableCellClicks();
                    }
                    
                    updateStatusDisplay();
                }
                
                showNotification('info', 'Game restarted!');
                
                // Add system message to chat
                addChatMessage({
                    message: `Game has been restarted!`,
                    isSystem: true,
                    timestamp: Date.now()
                });
            });
            
            // Add error event handler
            socket.on('error', ({ message }) => {
                showNotification('danger', message);
                console.log('Error received:', message);
            });
            
            // Game initialized event for random matches
            socket.on('gameInitialized', (data) => {
                console.log('Game initialized!', data);
                
                // Update game state
                gameState = data.gameState;
                currentPlayer = data.currentPlayer;
                gameActive = data.gameActive;
                
                // Update connection status
                updateConnectionStatus('connected');
                
                // Update board display
                updateBoardDisplay();
                
                // Update player names in labels
                const opponent = data.players.find(p => p.symbol !== playerSymbol);
                if (opponent) {
                    opponentName = opponent.name;
                    updatePlayerLabels();
                }
                
                // Make sure opponent name is set to something valid
                if (!opponentName || opponentName.trim() === '') {
                    opponentName = 'Opponent';
                }
                
                // Enable/disable cell clicks based on whose turn it is
                if (currentPlayer === playerSymbol) {
                    enableCellClicks();
                    statusDisplay.innerHTML = `Your turn <span class="player-symbol">(${playerSymbol})</span>`;
                } else {
                    disableCellClicks();
                    statusDisplay.innerHTML = `${opponentName}'s turn <span class="player-symbol">(${currentPlayer})</span>`;
                }
                
                showNotification('success', 'Game started!');
            });
            
            // Handle cell click
            function handleCellClick(cell) {
                const cellIndex = parseInt(cell.getAttribute('data-cell-index'));
                
                if (gameState[cellIndex] !== '' || !gameActive || currentPlayer !== playerSymbol || isSpectator) {
                    return;
                }
                
                // Emit move to server
                socket.emit('makeMove', { roomId, cellIndex });
                
                // Disable clicks until opponent's move
                disableCellClicks();
            }
            
            // Update the status display
            function updateStatusDisplay() {
                if (isSpectator) {
                    const currentPlayerName = participants.find(p => p.symbol === currentPlayer)?.name || '';
                    statusDisplay.innerHTML = `Spectating: ${currentPlayerName}'s turn <span class="player-symbol">(${currentPlayer})</span>`;
                } else if (currentPlayer === playerSymbol) {
                    statusDisplay.innerHTML = `Your turn <span class="player-symbol">(${playerSymbol})</span>`;
                } else {
                    // Make sure we have a valid opponent name
                    if (!opponentName || opponentName.trim() === '') {
                        opponentName = 'Opponent';
                    }
                    statusDisplay.innerHTML = `${opponentName}'s turn <span class="player-symbol">(${currentPlayer})</span>`;
                }
            }
            
            // Update connection status
            function updateConnectionStatus(status) {
                connectionStatus.classList.remove('status-waiting', 'status-connected', 'status-disconnected');
                
                if (status === 'connected') {
                    connectionStatus.classList.add('status-connected');
                    connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Connected';
                } else if (status === 'waiting') {
                    connectionStatus.classList.add('status-waiting');
                    connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Waiting for opponent...';
                } else {
                    connectionStatus.classList.add('status-disconnected');
                    connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Disconnected';
                }
            }
            
            // Update player labels
            function updatePlayerLabels() {
                if (isSpectator) {
                    // Find player names for X and O
                    const playerX = participants.find(p => p.symbol === 'X')?.name || 'Player X';
                    const playerO = participants.find(p => p.symbol === 'O')?.name || 'Player O';
                    
                    playerXLabel.textContent = `${playerX} X:`;
                    playerOLabel.textContent = `${playerO} O:`;
                } else if (playerSymbol === 'X') {
                    playerXLabel.textContent = `You X:`;
                    playerOLabel.textContent = `${opponentName} O:`;
                } else {
                    playerXLabel.textContent = `${opponentName} X:`;
                    playerOLabel.textContent = `You O:`;
                }
            }
            
            // Update score display
            function updateScoreDisplay() {
                scoreXDisplay.textContent = scores.X;
                scoreODisplay.textContent = scores.O;
            }
            
            // Update board display
            function updateBoardDisplay() {
                gameState.forEach((symbol, index) => {
                    if (symbol) {
                        cells[index].innerHTML = symbol;
                        cells[index].classList.add(symbol.toLowerCase());
                    }
                });
            }
            
            // Enable cell clicks
            function enableCellClicks() {
                if (isSpectator) return; // Spectators can't click
                
                cells.forEach(cell => {
                    const index = parseInt(cell.getAttribute('data-cell-index'));
                    if (gameState[index] === '') {
                        cell.style.cursor = 'pointer';
                    }
                });
            }
            
            // Disable cell clicks
            function disableCellClicks() {
                cells.forEach(cell => {
                    cell.style.cursor = 'not-allowed';
                });
            }
            
            // Show congratulations popup
            function showCongratsPopup(winner) {
                winnerMessage.textContent = `${winner} won the game!`;
                congratsPopup.style.display = 'flex';
            }
            
            // Draw winning line
            function drawWinningLine(combination) {
                const [a, b, c] = combination;
                const line = document.createElement('div');
                line.className = 'winning-line';
                
                // Add player-specific class
                if (gameState[a] === 'X') {
                    line.classList.add('x-winning-line');
                } else {
                    line.classList.add('o-winning-line');
                }
                
                // Get positions of first and last cell in the combination
                const cellA = cells[a].getBoundingClientRect();
                const cellC = cells[c].getBoundingClientRect();
                
                // Calculate the center points
                const boardRect = board.getBoundingClientRect();
                const startX = cellA.left + cellA.width / 2 - boardRect.left;
                const startY = cellA.top + cellA.height / 2 - boardRect.top;
                const endX = cellC.left + cellC.width / 2 - boardRect.left;
                const endY = cellC.top + cellC.height / 2 - boardRect.top;
                
                // Calculate line length and angle
                const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                const angle = Math.atan2(endY - startY, endX - startX) * (180 / Math.PI);
                
                // Set line position and dimensions
                line.style.width = `${length}px`;
                line.style.left = `${startX}px`;
                line.style.top = `${startY}px`;
                line.style.transform = `rotate(${angle}deg)`;
                
                // Add line to board
                board.appendChild(line);
                
                // Animate the line growth
                setTimeout(() => {
                    line.style.width = `${length}px`;
                }, 10);
            }
            
            // Show notification
            function showNotification(type, message) {
                notification.classList.remove('notification-info', 'notification-success', 'notification-warning', 'notification-danger');
                notification.classList.add(`notification-${type}`);
                
                // Set icon based on type
                if (type === 'success') {
                    notificationIcon.className = 'notification-icon fas fa-check-circle';
                } else if (type === 'warning') {
                    notificationIcon.className = 'notification-icon fas fa-exclamation-triangle';
                } else if (type === 'danger') {
                    notificationIcon.className = 'notification-icon fas fa-times-circle';
                } else {
                    notificationIcon.className = 'notification-icon fas fa-info-circle';
                }
                
                notificationText.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            socket.on('connect', () => {
                console.log('Connected to server');
                
                // Update status to show connected
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'connection-status status-connected';
                connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Connected';
                
                // For random matches, immediately mark as connected
                if (isRandomMatch) {
                    updateConnectionStatus('connected');
                }
                
                // Join room with player name and explicit host status
                socket.emit('joinRoom', { 
                    roomId: roomId,
                    playerName: playerName,
                    isSpectator: false,
                    isHost: sessionStorage.getItem('isHost') === 'true'
                });
                
                console.log(`Joining room ${roomId} as ${playerName} (host: ${sessionStorage.getItem('isHost')})`);
            });

            socket.on('error', (data) => {
                console.error('Server error:', data.message);
                addSystemMessage(`Error: ${data.message}`);
                
                // If the error is about host permissions, update UI accordingly
                if (data.message.includes('host')) {
                    updateHostControls(false);
                }
            });

            function updateHostControls(isHost) {
                // This function should only control game start/restart capabilities
                // It should NOT disable cell clicking, which is handled by enable/disableCellClicks
                console.log('Updating host controls:', isHost);
                
                // Removed the code that was disabling pointer events for cells
                // This was preventing non-host players from interacting with the board
            }

            // Update participant list handler
            socket.on('updateParticipants', (data) => {
                console.log('Received participants update:', data);
                updateParticipantCount(data.players.length, data.spectators.length);
                
                // Update host status
                const player = data.players.find(p => p.name === playerName);
                if (player) {
                    console.log(`Player ${playerName} host status:`, player.isHost);
                    updateHostControls(player.isHost);
                }
            });

            // Update start game event handler
            document.getElementById('startBtn').addEventListener('click', () => {
                if (!isHost) {
                    console.log('Not host, cannot start game');
                    addSystemMessage('Only the host can start the game');
                    return;
                }

                console.log('Emitting startGame event');
                socket.emit('startGame', {
                    roomId: roomId,
                    playerName: playerName
                });
            });

            // Add game starting handler
            socket.on('gameStarting', () => {
                console.log('Game is starting!');
                addSystemMessage('Game is starting...');
                
                // Disable the start button to prevent multiple clicks
                const startBtn = document.getElementById('startBtn');
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'Starting...';
                }
            });

            // Create a proper player symbol span
            if (!statusDisplay.querySelector('.player-symbol')) {
                // Update the status display with game information
                if (isRandomMatch) {
                    statusDisplay.innerHTML = `Game in progress. Your symbol is <span class="player-symbol">(${playerSymbol})</span>`;
                }
            }
            
            // For random matches, set game as active right away
            if (isRandomMatch) {
                gameActive = true;
                
                // Enable clicking if it's your turn
                if (playerSymbol === 'X') {  // X always goes first
                    enableCellClicks();
                } else {
                    disableCellClicks();
                }
                
                // Update player labels
                updatePlayerLabels();
            } else {
                statusDisplay.innerHTML = 'Waiting for game to start...';
            }
        });
    </script>
</body>
</html>